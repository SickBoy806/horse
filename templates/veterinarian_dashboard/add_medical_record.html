{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="flex items-center justify-between mb-4">
  <h2 class="text-2xl font-bold">Add Medical Record</h2>
 <a href="{% url 'vet_dashboard' branch=branch.name %}" class="text-sm bg-gray-300 hover:bg-gray-400 text-black font-semibold px-4 py-2 rounded shadow">
    ‚Üê Back to Dashboard
</a>

</div>

<form method="POST" enctype="multipart/form-data" class="bg-white p-6 shadow-md rounded space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Render all fields dynamically -->
    {% for field in form.visible_fields %}
      <div id="div_id_{{ field.name }}">
        <label for="{{ field.id_for_label }}" class="block text-gray-700 font-semibold mb-1">
          {{ field.label }}
        </label>
        {{ field|add_class:"w-full p-2 border border-gray-300 rounded" }}
        {% if field.help_text %}
          <p class="text-sm text-gray-500">{{ field.help_text }}</p>
        {% endif %}
        {% for error in field.errors %}
          <p class="text-red-500 text-sm">{{ error }}</p>
        {% endfor %}
      </div>
    {% endfor %}

    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
        Save Record
    </button>
</form>

<!-- üß† JavaScript for dynamic field toggling -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const reportTypeField = document.getElementById('id_report_type');

    const fieldMap = {
        breeding: ['mating_date', 'expected_delivery_date', 'breeding_method'],
        lab_diagnosis: ['lab_test_name', 'test_result', 'sample_type'],
        deworming: ['dewormer_name', 'next_deworming_date'],
        postmortem: ['cause_of_death', 'postmortem_findings'],
        transfer: ['transfer_from', 'transfer_to', 'reason_for_transfer'],
        referral: ['referred_to', 'referral_reason'],
        dipping: ['dip_type', 'dipping_location'],
        surgery: ['surgery_type', 'anesthesia_used'],
        vaccination: ['vaccine_name', 'next_due_date'],
        checkup: ['weight']
    };

    const alwaysShow = ['report_type', 'animal', 'diagnosis', 'treatment', 'document'];

    function hideAllConditionalFields() {
        Object.values(fieldMap).flat().forEach(name => {
            const el = document.getElementById(`div_id_${name}`);
            if (el && !alwaysShow.includes(name)) el.style.display = 'none';
        });
    }

    function showRelevantFields(type) {
        hideAllConditionalFields();
        const toShow = fieldMap[type] || [];
        toShow.forEach(name => {
            const el = document.getElementById(`div_id_${name}`);
            if (el) el.style.display = '';
        });
    }

    reportTypeField.addEventListener('change', function () {
        showRelevantFields(this.value);
    });

    showRelevantFields(reportTypeField.value); // Show on load
});
</script>

{% endblock %}
