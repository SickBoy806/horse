{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12">
  <div class="max-w-4xl mx-auto px-6">

    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Add New Animal</h2>

      <!-- Role-based Dashboard Redirect -->
      {% if request.user.role == 'admin' and request.user.branch and request.user.branch.slug %}
        <a href="{% url 'admin_dashboard' branch=request.user.branch.slug %}"
           class="inline-flex items-center text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Dashboard
        </a>
      {% elif request.user.role == 'veterinarian' and request.user.branch and request.user.branch.slug %}
        <a href="{% url 'vet_dashboard' branch=request.user.branch.slug %}"
           class="inline-flex items-center text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Dashboard
        </a>
      {% elif request.user.role == 'staff' and request.user.branch and request.user.branch.slug %}
        <a href="{% url 'staff_dashboard' branch=request.user.branch.slug %}"
           class="inline-flex items-center text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Dashboard
        </a>
      {% else %}
        <!-- Fallback dashboard button if no specific role match -->
        <a href="{% url 'login' %}"
           class="inline-flex items-center text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Login
        </a>
      {% endif %}
    </div>

    <!-- Debug Info -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
      <h3 class="font-semibold text-gray-700 mb-2">Debug Information</h3>
      <div class="text-sm text-gray-600 space-y-1">
        <p><strong>Form action URL:</strong> {% url 'add_animal' %}</p>
        <p><strong>Branch:</strong> {{ request.user.branch.name }} ({{ request.user.branch.slug }})</p>
        <p><strong>Logged in as:</strong> {{ request.user.get_full_name }} ({{ request.user.role }})</p>
      </div>
    </div>

    <!-- Flash Messages -->
    {% if messages %}
      <div class="mb-6 space-y-3">
        {% for message in messages %}
          <div class="p-4 text-white rounded-lg shadow-sm
            {% if message.tags == 'success' %}bg-green-600
            {% elif message.tags == 'error' %}bg-red-600
            {% else %}bg-blue-600{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Animal Form -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="px-10 py-8">
        <form method="POST" action="{% url 'add_animal' %}" enctype="multipart/form-data" class="space-y-8">
          {% csrf_token %}

          <!-- Non-field errors -->
          {% if form.non_field_errors %}
            <div class="mb-4 text-red-600 font-semibold">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Basic Information Section -->
          <div class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Name:</label>
                {{ form.name|add_class:"w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white" }}
                {% if form.name.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.name.errors|striptags }}</p>
                {% endif %}
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Species:</label>
                {{ form.species|add_class:"w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white" }}
                {% if form.species.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.species.errors|striptags }}</p>
                {% endif %}
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Date of Birth:</label>
                <input type="date"
                       id="date_of_birth"
                       name="date_of_birth"
                       class="w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white"
                       onchange="calculateAge()"
                       value="{{ form.date_of_birth.value|default:'' }}">
                <p class="text-xs text-gray-500 mt-2">Select the animal's birth date</p>
                <div id="calculated_age" class="text-sm font-medium text-blue-600 mt-2 {% if not form.date_of_birth.value %}hidden{% endif %}"></div>
                <input type="hidden" id="age_field" name="age" value="{{ form.age.value|default:'' }}">
                {% if form.date_of_birth.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.date_of_birth.errors|striptags }}</p>
                {% endif %}
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Force Number:</label>
                {{ form.force_number|add_class:"w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white" }}
                {% if form.force_number.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.force_number.errors|striptags }}</p>
                {% endif %}
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">Owner Name:</label>
              {{ form.owner_name|add_class:"w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white" }}
              {% if form.owner_name.errors %}
                <p class="text-red-600 text-sm mt-1">{{ form.owner_name.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Photo Section -->
          <div class="border-t border-gray-200 pt-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Animal Photo</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Upload Photo:</label>
                {{ form.photo|add_class:"w-full border border-gray-300 px-6 py-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" }}
                {% if form.photo.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.photo.errors|striptags }}</p>
                {% endif %}
              </div>
              <div class="flex justify-center mt-6">
                <img id="preview" src="#" class="hidden w-48 h-48 object-cover rounded-lg border-2 border-gray-300 shadow-sm" alt="Preview">
              </div>
            </div>
          </div>

          <!-- Assignment Section -->
          {% if form.assigned_users %}
            <div class="border-t border-gray-200 pt-8">
              <h3 class="text-lg font-semibold text-gray-800 mb-6">User Assignment</h3>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Assign to Other Users:</label>
                <div class="border border-gray-300 rounded-lg p-6 bg-gray-50">
                  {{ form.assigned_users }}
                </div>
                {% if form.assigned_users.errors %}
                  <p class="text-red-600 text-sm mt-1">{{ form.assigned_users.errors|striptags }}</p>
                {% endif %}
              </div>
            </div>
          {% endif %}

          <br>

          <!-- Submit Button -->
          <div class="border-t border-gray-200 pt-10 flex justify-center">
            <button type="submit" class="bg-blue-600 text-white px-16 py-5 rounded-xl hover:bg-blue-700 transition-colors font-semibold shadow-lg text-lg tracking-wide">
              Add Animal
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Script -->
<script>
  const photoInput = document.querySelector('input[type="file"]');
  const preview = document.getElementById('preview');

  if (photoInput) {
    photoInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.classList.remove("hidden");
      } else {
        preview.classList.add("hidden");
      }
    });
  }

  // Age calculation function
  function calculateAge() {
    const birthDateInput = document.getElementById('date_of_birth');
    const birthDate = new Date(birthDateInput.value);
    const today = new Date();

    if (birthDate && birthDate <= today) {
      let ageInMilliseconds = today - birthDate;
      let ageInDays = Math.floor(ageInMilliseconds / (1000 * 60 * 60 * 24));
      let years = Math.floor(ageInDays / 365);
      let months = Math.floor((ageInDays % 365) / 30);
      let days = (ageInDays % 365) % 30;

      let ageText = '';
      if (years > 0) {
        ageText += years + (years === 1 ? ' year' : ' years');
        if (months > 0) {
          ageText += ', ' + months + (months === 1 ? ' month' : ' months');
        }
      } else if (months > 0) {
        ageText += months + (months === 1 ? ' month' : ' months');
        if (days > 0) {
          ageText += ', ' + days + (days === 1 ? ' day' : ' days');
        }
      } else {
        ageText = days + (days === 1 ? ' day' : ' days');
      }

      document.getElementById('calculated_age').innerHTML = 'Calculated Age: ' + ageText;
      document.getElementById('calculated_age').classList.remove('hidden');

      // Store the calculated age in the hidden field (you might want to adjust this format)
      document.getElementById('age_field').value = years + '.' + months;
    } else {
      document.getElementById('calculated_age').classList.add('hidden');
      document.getElementById('age_field').value = '';
    }
  }

  // Clear form function
  function clearForm() {
    document.querySelector('form').reset();

    if (preview) {
      preview.classList.add('hidden');
      preview.src = '#';
    }

    document.getElementById('calculated_age').classList.add('hidden');
    document.getElementById('age_field').value = '';

    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const successMessages = document.querySelectorAll('.bg-green-600');
    if (successMessages.length > 0) {
      setTimeout(clearForm, 1000);
    }
  });

  // Trigger age calculation on page load if date is already set
  document.addEventListener('DOMContentLoaded', function() {
    calculateAge();
  });
</script>
{% endblock %}
